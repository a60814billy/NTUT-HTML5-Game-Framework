var Framework=(function(a){a.Util={};a.Util.isUndefined=function(b){return(typeof b==="undefined")};a.Util.isNull=function(b){return(b===null)};a.Util.isFunction=function(b){return(typeof b==="function")};a.Util.isNumber=function(b){return(typeof b==="number")};a.Util.isObject=function(b){return(typeof b==="object")};a.Util.isBoolean=function(b){return(typeof b==="boolean")};a.Util.isString=function(b){return(typeof b==="string")};a.Util.isCanvas=function(b){if(!a.Util.isUndefined(b.tagName)){return(b.tagName==="CANVAS")}return false};a.Util.namespace=function(e){var d=e.split("."),c=a,b;if(d[0]==="Framework"){d=d.slice(1)}for(b=0;b<d.length;b+=1){if(a.Util.isUndefined(typeof c[d[b]])){c[d[b]]={}}c=c[d[b]]}return d};a.Util.overrideProperty=function(c,d){for(var b in c){if(a.Util.isUndefined(d[b])){d[b]=c[b]}}return d};return a})(Framework||{});if(Framework.Util.isUndefined(Date.prototype.format)){Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length==1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b}}var Framework=(function(a){a.Class=function(){if(this instanceof a.Class){a.DebugInfo.Log.error("不能在Framework.Class之前使用new關鍵字");throw"can't use new keywork on Framework.Class"}var d,c,g,e,b;if(arguments.length===1){c=arguments[0]}else{if(arguments.length===2){d=arguments[0];c=arguments[1]}}g=function(){if(a.Util.isUndefined(this)){a.DebugInfo.Log.error("必須使用new關鍵字");throw"must be use new keyword"}if(g.uber&&g.uber.hasOwnProperty("__construct")){g.uber.__construct.apply(this,arguments)}if(g.prototype.hasOwnProperty("__construct")){g.prototype.__construct.apply(this,arguments)}};d=d||Object;e=function(){};e.prototype=d.prototype;g.prototype=new e();g.uber=d.prototype;g.prototype.constructor=g;for(b in c){if(c.hasOwnProperty(b)){g.prototype[b]=c[b]}}return g};a.inheritance=function(e,d){var c=function(){};var b=new e();c.prototype=e.prototype;b.prototype=new c;b.uber=e.prototype;for(var f in d){if(d.hasOwnProperty(f)){b[f]=d[f]}}return b};return a})(Framework||{});var Framework=(function(a){a.DebugInfo=(function(){var c=false,e=false,d={};var f=document.createElement("div");f.style.width="500px";f.style.height="200px";f.style.backgroundColor="#f0f0f0";f.style.position="absolute";f.style.top="10px";f.style.border="1px solid #000";f.style.right="10px";f.style.zIndex="99999";f.style.overflowY="scroll";var b=function(h,j){var k=document.createElement("p");k.style.margin="0";k.style.minWidth="600px";k.style.padding="2px 0 2px 5px";var g=document.createTextNode("["+(new Date()).format("hh:mm:ss")+"] ["+h+"] "+j);k.appendChild(g);f.appendChild(k);f.scrollTop=f.scrollHeight;return k};d.Log={};d.Log.info=function(g){b("Info",g).style.backgroundColor="#80ffff"};d.Log.error=function(g){b("Error",g).style.backgroundColor="#ff8080"};d.Log.warning=function(g){b("Warning",g).style.backgroundColor="#ffff80"};d.Log.console=function(g){if(c){console.Log(g)}};d.show=function(h){f.style.visibility="visible";f.style.width="500px";f.style.height="200px";f.style.border="1px solid #000";if(!e){var g=h||document.body;g.appendChild(f)}};d.hide=function(h){var g="0px";f.style.visibility="hidden";f.style.border=g;f.style.width=g;f.style.height=g};return d})();return a})(Framework||{});var Framework=(function(a){a.FpsAnalysis=function(){if(!(this instanceof arguments.callee)){return new arguments.callee()}var f=new Array(50);var b=new Array(50);for(var c=0;c<b.length;c++){f[c]=0;b[c]=0}var e=1;var d=0;f[0]=(new Date()).getTime();return{update:function(){f[e]=(new Date()).getTime();d-=b[e];b[e]=f[e]-(e==0?f[f.length-1]:f[e-1]);d+=b[e];e=(++e)%b.length},getUpdateFPS:function(){return Math.floor(1000/(d/b.length))}}};return a})(Framework||{});var Framework;Framework=(function(a){a.GameObject=a.Class({__construct:function(){Object.defineProperty(this,"position",{get:function(){return this.relativePosition},set:function(c){if(a.Util.isUndefined(c.x)){c.x=this.position.x}if(a.Util.isUndefined(c.y)){c.y=this.position.y}this.relativePosition=c}});Object.defineProperty(this,"rotation",{get:function(){return this.relativeRotation},set:function(c){this.relativeRotation=c}});Object.defineProperty(this,"scale",{get:function(){return this.relativeScale},set:function(c){this.relativeScale=c}});Object.defineProperty(this,"width",{get:function(){var c=0;if(this.texture){c=this.texture.width}if(this.col){c=this.texture.width/this.col}return c*this.absoluteScale}});Object.defineProperty(this,"height",{get:function(){var c=0;if(this.texture){c=this.texture.height}if(this.row){c=this.texture.height/this.row}return c*this.absoluteScale}});var b=function(c,h){var e=(h/180)*Math.PI,g=Math.cos(e),d=Math.sin(e),j=c.x*g-c.y*d,f=c.x*d+c.y*g;return{x:j,y:f}};Object.defineProperty(this,"upperLeft",{get:function(){var e=-this.width/2,c=-this.height/2,d=b({x:e,y:c},this.absoluteRotation);return{x:this.absolutePosition.x+d.x,y:this.absolutePosition.y+d.y}}});Object.defineProperty(this,"upperRight",{get:function(){var e=this.width/2,c=-this.height/2,d=b({x:e,y:c},this.absoluteRotation);return{x:this.absolutePosition.x+d.x,y:this.absolutePosition.y+d.y}}});Object.defineProperty(this,"lowerLeft",{get:function(){var e=-this.width/2,c=this.height/2,d=b({x:e,y:c},this.absoluteRotation);return{x:this.absolutePosition.x+d.x,y:this.absolutePosition.y+d.y}}});Object.defineProperty(this,"lowerRight",{get:function(){var e=this.width/2,c=this.height/2,d=b({x:e,y:c},this.absoluteRotation);return{x:this.absolutePosition.x+d.x,y:this.absolutePosition.y+d.y}}});this.rotation=0;this.scale=1;this.position={x:0,y:0};this.relativePosition={x:0,y:0};this.relativeRotation=0;this.relativeScale=1;this.absolutePosition={x:0,y:0};this.absoluteRotation=0;this.absoluteScale=1},countAbsoluteProperty:function(){var b,e=0,f=1,d=0,c=0;if(this.spriteParent){e=this.spriteParent.absoluteRotation;f=this.spriteParent.absoluteScale;d=this.spriteParent.absolutePosition.x;c=this.spriteParent.absolutePosition.y}this.absoluteRotation=this.rotation+e;this.absoluteScale=this.scale*f;b=(e/180)*Math.PI;this.absolutePosition.x=Math.floor((this.relativePosition.x*Math.cos(b)-this.relativePosition.y*Math.sin(b)))*f+d;this.absolutePosition.y=Math.floor((this.relativePosition.x*Math.sin(b)+this.relativePosition.y*Math.cos(b)))*f+c},update:function(){},draw:function(){},toString:function(){return"[GameObject Object]"},teardown:function(){}});return a})(Framework||{});var Framework=(function(a){a.Sprite=a.Class(a.GameObject,{__construct:function(b){this.id=undefined;this.type=undefined;this.texture=undefined;this.isDrawBoundry=false;this.isDrawPace=false;if(a.Util.isString(b)){this.id=b;a.ResourceManager.loadImage({id:b,url:b});this.type="image"}else{if(a.Util.isCanvas(b)){this.texture=b;this.type="canvas"}else{if(!a.Util.isUndefined(b)){a.DebugInfo.Log.error("Sprite 不支援的參數 "+b)}}}},draw:function(b){this.countAbsoluteProperty();var j,e,m,k,d;if(a.Util.isUndefined(this.texture)){this.texture=a.ResourceManager.getResource(this.id)}if(this.type==="image"||this.type==="canvas"){e=document.createElement("canvas");m=this.texture.width*this.scale;k=this.texture.height*this.scale;var c=Math.ceil(Math.sqrt(Math.pow(k,2)+Math.pow(m,2)));e.width=c;e.height=c;var l=e.width/m,h=e.height/k,g=e.width/2,f=e.height/2;d=e.getContext("2d");d.translate(g,f);d.rotate(this.absoluteRotation/180*Math.PI);d.translate(-g,-f);d.scale(this.absoluteScale,this.absoluteScale);d.drawImage(this.texture,(e.width-m)/2/this.absoluteScale,(e.height-k)/2/this.absoluteScale);if(this.isDrawBoundry){d.rect((e.width-m)/2/this.absoluteScale,(e.height-k)/2/this.absoluteScale,this.texture.width,this.texture.height)}if(this.isDrawPace){b.rect(this.absolutePosition.x,this.absolutePosition.y,1,1)}d.stroke();b.drawImage(d.canvas,this.absolutePosition.x-e.width/2,this.absolutePosition.y-e.height/2)}},toString:function(){return"[Sprite Object]"},teardown:function(){if(this.type==="image"){a.ResourceManager.destroyResource(this.id)}}});return a})(Framework||{});var Framework=(function(a){a.AnimationSprite=a.Class(a.GameObject,{__construct:function(b){this._id=undefined;this._type=undefined;this._isLoadSprite=false;this._sprites=[];this._previousTime=(new Date()).getTime();this._start=false;this.col=1;this.row=1;this.from=0;this.to=0;this.index=0;this.speed=10;this.loop=true;this.maxIndex=0;this.finishPlaying=function(){};if(!a.Util.isUndefined(b.url)){if(a.Util.isString(b.url)){this._id=b.url;if(a.Util.isUndefined(b.col)||a.Util.isUndefined(b.row)){a.DebugInfo.Log.error("AnimationSprite Error : 建構子參數錯誤，需指定col、row");throw new SyntaxError("AnimationSprite constructor arguments error")}else{this.col=b.col;this.row=b.row;this.maxIndex=this.col*this.row-1}}else{if(Array.isArray(b.url)){this.maxIndex=b.url.length-1;this.row=b.url.length}else{a.DebugInfo.Log.error("AnimationSprite Error : 建構子參數錯誤，url格式不正確");throw new SyntaxError("AnimationSprite constructor arguments error")}}}else{a.DebugInfo.Log.error("AnimationSprite Error : 建構子參數錯誤");throw new SyntaxError("AnimationSprite constructor arguments error")}this.speed=b.speed||24;this.loop=(a.Util.isUndefined(b.loop)?true:b.loop);if(a.Util.isString(b.url)){a.ResourceManager.loadImage({id:this._id,url:this._id});this._type="one"}else{if(Array.isArray(b.url)){this._id=[];this._type="more";b.url.forEach(function(c){this._sprites.push(new a.Sprite(c))},this);this._isLoadSprite=true}else{if(!a.Util.isUndefined(b)){a.DebugInfo.Log.error("AnimationSprite 不支援的參數 "+b)}}}},_nextFrame:function(){if(this._start){this.index++;if(this.index>this.to){if(this.loop){this.index=this.from}else{this.index=this.to;this._start=false;this.finishPlaying.call(this)}}}},start:function(b){var b=b||{};this.from=(a.Util.isUndefined(b.from)?0:b.from);this.to=(a.Util.isUndefined(b.to)?this.maxIndex:b.to);this.speed=(a.Util.isUndefined(b.speed)?this.speed:b.speed);this.loop=(a.Util.isUndefined(b.loop)?this.loop:b.loop);this._start=true;this._previousTime=(new Date()).getTime();this.finishPlaying=b.finishPlaying||function(){};this.userInputFrom=this.from;this.userInputTo=this.to;if(this.userInputFrom>this.userInputTo){this.from=this.maxIndex-this.from;this.to=this.maxIndex-this.to;if(this._type==="more"){this._sprites.reverse()}}this.index=this.from},stop:function(){this._start=false},resume:function(){this._previousTime=(new Date()).getTime();this._start=true},update:function(){var c=(new Date()).getTime();if((c-this._previousTime)>(1000/this.speed)){for(var d=1,b=Math.floor((c-this._previousTime)/(1000/this.speed));d<=b;d++){if(this._start){this._nextFrame()}}this._previousTime=c}if(this._isLoadSprite){if(this._type==="more"){this.texture=this._sprites[this.index]}this._sprites[this.index].spriteParent=this.spriteParent;this._sprites[this.index].position=this.position;this._sprites[this.index].rotation=this.rotation;this._sprites[this.index].scale=this.scale;this._sprites[this.index].isDrawBoundry=this.isDrawBoundry;this._sprites[this.index].isDrawPace=this.isDrawPace}else{if(this._type==="one"){(function(){this.texture=a.ResourceManager.getResource(this._id);for(var j=0;j<this.col*this.row;j++){var h=document.createElement("canvas");var k=this.texture.width*this.scale;var g=this.texture.height*this.scale;h.width=(this.texture.width)/this.col;h.height=(this.texture.height)/this.row;var e=h.getContext("2d");e.drawImage(this.texture,-(this.texture.width/this.col)*(j%this.col),-(this.texture.height/this.row)*(Math.floor(j/this.col)));var f=new a.Sprite(h);f.position=this.position;f.rotation=this.rotation;f.scale=this.scale;f.spriteParent=this.spriteParent;this._sprites.push(f)}if(this.userInputFrom>this.userInputTo){this._sprites.reverse()}}).call(this);this._isLoadSprite=true}}},draw:function(b){if(this._isLoadSprite){this._sprites[this.index].draw(b)}},toString:function(){return"[AnimationSprite Object]"},teardown:function(){if(this.type==="one"){a.ResourceManager.destroyResource(this.id)}else{if(this.type==="more"){this._sprites.forEach(function(b){b.teardown()},this)}}}});return a})(Framework||{});var Framework=(function(a){a.Scene=a.Class(a.GameObject,{__construct:function(b){this.id=undefined;this.type=undefined;this.texture=undefined;this.attachArray=[]},update:function(){var b;for(b=0;b<this.attachArray.length;b++){this.attachArray[b].update()}},draw:function(c){this.countAbsoluteProperty();var b,d;for(b=0;b<this.attachArray.length;b++){this.attachArray[b].draw(c)}},attach:function(b){this.attachArray.push(b);b.spriteParent=this},detach:function(d){var b=-1,c;for(c=0;c<this.attachArray.length;c++){if(this.attachArray[c]===d){b=c;break}}if(b>-1){this.attachArray.splice(b,1);d.spriteParent={}}},toString:function(){return"[Scene Object]"}});return a})(Framework||{});var Framework=(function(a){a.KeyBoardManager=(function(){var m=0,s=1000,k={},o=[],e={8:"Backspace",9:"Tab",13:"Enter",16:"shiftKey",17:"ctrlKey",18:"altKey",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},j={},c={},h=function(){},p=function(){};_subjectArr=[],_subjectLenth=0;var f=function(x){x.preventDefault();var w=e[x.which||x.keyCode],u;if(!a.Util.isUndefined(k[w])){var v=k[w];v.lastTimeDiff=x.timeStamp-v.firstTimeStamp}else{k[w]={key:w,firstTimeStamp:x.timeStamp,ctrlKey:x.ctrlKey,shiftKey:x.shiftKey,altKey:x.altKey,lastTimeDiff:0}}for(u=0;u<_subjectLenth;u++){h.call(_subjectArr[u],k[w],k,x)}};var t=function(w){w.preventDefault();var v=e[w.which||w.keyCode],u={};o.push(k[v]);k[v]=null;delete k[v];for(u in k){if(a.Util.isUndefined(k[u][v])){return}k[u][v]=false}for(i=0;i<_subjectLenth;i++){p.call(_subjectArr[i],w)}};var q=function(u){h=u};var l=function(u){p=u};var d=function(u){s=u};var r=function(u,v){return String.fromCharCode(u)===v.toUpperCase()};var g=function(){o.length=0;clearTimeout(m);m=setTimeout(g,s)};var n=function(u){_subjectArr.push(u);_subjectLenth++};var b=function(w){var v,u=_subjectArr.length;for(v=0;v<u;v++){if(_subjectArr[v]===w){break}}_subjectArr.splice(v,1);_subjectLenth--};j=function(){window.addEventListener("keydown",f,false);window.addEventListener("keyup",t,false);g()};j.prototype={addSubject:n,removeSubject:b,setClearHistoryTime:d,setKeydownEvent:q,setKeyupEvent:l,keydownList:k,mappingTable:e,keypressHistory:o};c=new j();return c})();return a})(Framework||{});var Framework=(function(Framework){Framework.ResourceManager=(function(){var _requestCount=0,_responseCount=0,_timeountIDPrevious=0,_timeountID=0,_intervalID=0,_responsedResource={},_subjectFunction=function(){},ResourceManagerClass=function(){},ResourceManagerIntance=function(){};var getFinishedRequestPercent=function(){return _responseCount/_requestCount*100};var getRequestCount=function(){return _requestCount};var getResponseCount=function(){return _responseCount};var loadImage=function(requestOption){var imageObj=new Image();imageObj.src=requestOption.url;_requestCount++;if(_intervalID===null){_intervalID=setInterval(detectAjax,50);finishLoading()}imageObj.onload=function(){_responseCount++;_responsedResource[requestOption.id]={url:requestOption.url,response:imageObj}}};var minAjaxJSON=function(requestOption){requestOption.systemSuccess=function(responseText,textStatus,xmlHttpRequest){var responseJSON=eval("("+responseText.trim()+")");_responsedResource[requestOption.id]={url:requestOption.url,response:responseJSON};_responseCount++};minAjax(requestOption.type,requestOption)};var minAjax=function(type,requestOption){var userSettings=userSettings||{};userSettings.type=type||"POST";if(!Framework.Util.isUndefined(requestOption.data)){userSettings.data=requestOption.data}if(!Framework.Util.isUndefined(requestOption.systemSuccess)){userSettings.success=requestOption.systemSuccess}ajax(requestOption,userSettings)};var ajax=function(requestOption,userSettings){_requestCount++;var defaultSettings={type:"POST",cache:false,async:true,contentType:"application/x-www-form-urlencoded; charset=UTF-8",error:function(xmlHttpRequest,textStatus){},statusCode:{},success:function(data,textStatus,xmlHttpRequest){}};var userSettings=userSettings||defaultSettings;userSettings=Framework.Util.overrideProperty(defaultSettings,userSettings);if(window.XMLHttpRequest){var xhr=new XMLHttpRequest();xhr.onload=(function(){if(xhr.readyState===4){if(xhr.status===200){_responsedResource[requestOption.id]={url:requestOption.url,response:xhr.responseText};userSettings.success(xhr.responseText,xhr.statusText,xhr)}else{userSettings.error(xhr,xhr.statusText)}}})}if(!userSettings.cache&&Framework.Util.isUndefined(userSettings.data)&&userSettings.type==="GET"){requestOption.url=requestOption.url+"?"+Math.random()}else{if(!Framework.Util.isUndefined(userSettings.data)&&userSettings.data.trim()!==""){requestOption.url=requestOption.url+"?"+userSettings.data.trim()}}xhr.open(userSettings.type,requestOption.url,userSettings.async);xhr.overrideMimeType("text/plain; charset=x-user-defined");if(userSettings.type==="GET"){xhr.send()}else{xhr.setRequestHeader("Content-Type",userSettings.contentType);xhr.send(userSettings.data)}};var getResource=function(id){if(Framework.Util.isUndefined(_responsedResource[id])){throw ('"'+id+'" is undefined Resource.')}return _responsedResource[id].response};var destroyResource=function(id){_responsedResource[id].response=null;_responsedResource[id].url=null;_responsedResource[id]=null;delete _responsedResource[id]};var setSubjectFunction=function(subjectFunction){_subjectFunction=subjectFunction};var detectAjax=function(){ajaxProcessing=(_requestCount!==_responseCount)||(_requestCount===0)};var stopDetectingAjax=function(){clearInterval(_intervalID);_intervalID=null};var finishLoading=function(){detectAjax();if(!ajaxProcessing){stopDetectingAjax();_subjectFunction()}else{_timeountIDPrevious=_timeountID;_timeountID=setTimeout(function(){finishLoading();clearTimeout(_timeountIDPrevious)},500)}};ResourceManagerClass=function(subjectFunction){_requestCount=0;_responseCount=0;_responsedResource={};if(!Framework.Util.isUndefined(subjectFunction)){_subjectFunction=subjectFunction}finishLoading()};ResourceManagerClass.prototype={loadImage:loadImage,loadJSON:minAjaxJSON,destroyResource:destroyResource,getResource:getResource,setSubjectFunction:setSubjectFunction,getFinishedRequestPercent:getFinishedRequestPercent,getRequestCount:getRequestCount,getResponseCount:getResponseCount};ResourceManagerIntance=new ResourceManagerClass();return ResourceManagerIntance})();return Framework})(Framework||{});var Framework=(function(a){a.Level=a.Class({__construct:function(){this.rootScene=new a.Scene();this.autoDelete=true},initializeProgressResource:function(){},loadingProgress:function(b){b.font="90px Arial";b.fillText(a.ResourceManager.getFinishedRequestPercent()+"%",b.canvas.width/2-50,b.canvas.height/2)},initialize:function(){},update:function(){},draw:function(){},click:function(b){},mousedown:function(b){},mouseup:function(b){},mousemove:function(b){},touchstart:function(b){},touchend:function(b){},touchmove:function(b){},keydown:function(b){},keyup:function(b){},keypress:function(b){},teardown:function(){},autodelete:function(){for(var b in this.rootScene.attachArray){this.rootScene.attachArray[b].teardown();this.rootScene.attachArray[b]=null;delete this.rootScene.attachArray[b];this.rootScene.attachArray.length=0}this.teardown()}});return a})(Framework||{});var Framework=(function(a){a.Game=(function(){var b={};b._isInit=false;b._isRun=false;b._updateFPS=60;b._drawFPS=60;b._fpsContext=null;b._fpsAnalysis=new a.FpsAnalysis();b._drawfpsAnalysis=new a.FpsAnalysis();b._runInstance=null;b._levels=[];b._currentLevel=undefined;b._context=null;b._tempUpdate=function(){};b._tempDraw=function(c){};b.click=function(c){b._currentLevel.click(c)};b.mousedown=function(c){b._currentLevel.mousedown(c)};b.mouseup=function(c){b._currentLevel.mouseup(c)};b.mousemove=function(c){b._currentLevel.mousemove(c)};b.touchstart=function(c){b._currentLevel.touchstart(c)};b.touchend=function(c){b._currentLevel.touchend(c)};b.touchmove=function(c){b._currentLevel.touchmove(c)};b.keydown=function(c){b._currentLevel.keydown(c)};b.keyup=function(c){b._currentLevel.keyup(c)};b.keypress=function(c){b._currentLevel.keypress(c)};b.eventHandler=function(c){switch(c.type){case"contextmenu":case"click":b.click(c);return false;break;case"mousedown":b.mousedown(c);break;case"mouseup":b.mouseup(c);break;case"mousemove":b.mousemove(c);break;case"touchstart":c.preventDefault();b.touchstart(c);break;case"touchend":c.preventDefault();b.touchend(c);break;case"touchmove":c.preventDefault();b.touchmove(c);break}};b._canvas=document.createElement("canvas");b._canvas.setAttribute("id","__game_canvas__");b._canvas.width=innerWidth;b._canvas.height=innerHeight;b._context=b._canvas.getContext("2d");b.initializeProgressResource=function(){b._currentLevel.initializeProgressResource()};b.loadingProgress=function(c){b._currentLevel.loadingProgress(c,{request:a.ResourceManager.getRequestCount(),response:a.ResourceManager.getResponseCount(),percent:a.ResourceManager.getFinishedRequestPercent()})};b.initialize=function(){b._currentLevel.initialize()};b.update=function(){b._currentLevel.update()};b.draw=function(){b._currentLevel.draw()};b._teardown=function(){a.KeyBoardManager.removeSubject(b._currentLevel);if(this._currentLevel.autoDelete){this._currentLevel.autodelete()}};b._findLevel=function(d){for(var e=0,c=b._levels.length;e<c;e++){if(b._levels[e].name===d){return b._levels[e].level}}return null};b.addNewLevel=function(d){for(var c in d){if(d.hasOwnProperty(c)){if(a.Util.isNull(b._findLevel(c))){b._levels.push({name:c,level:d[c]})}else{a.DebugInfo.Log.error("Game : 關卡名稱不能重複");throw new Error("Game: already has same level name")}}}};b.goToLevel=function(c){b.stop();b._teardown();b._currentLevel=b._findLevel(c);if(a.Util.isUndefined(b._currentLevel)){a.DebugInfo.Log.error("Game : 找不到關卡");throw new Error("Game : levelname not found.")}b.start()};b.goToNextLevel=function(){b.stop();b._teardown();var c=false;for(var d in b._levels){if(c){b._currentLevel=b._levels[d].level;b.start();return}if(b._levels[d].level===b._currentLevel){c=true}}a.DebugInfo.Log.error("Game : 無下一關");throw new Error("Game : can't goto next level.")};b.goToPreviousLevel=function(){b.stop();b._teardown();var c=false;var e=undefined;for(var d in b._levels){if(b._levels[d].level===b._currentLevel){if(!a.Util.isUndefined(e)){b._currentLevel=e;b.start();return}break}e=b._levels[d].level}a.DebugInfo.Log.error("Game : 無前一關");throw new Error("Game : can't goto previous level.")};b.start=function(){if(a.Util.isUndefined(b._currentLevel)){b._currentLevel=b._levels[0].level}var c=b;if(!b._isInit){document.body.appendChild(b._canvas);b._canvas.addEventListener("click",function(f){c.eventHandler(f)});b._canvas.addEventListener("mousedown",function(f){c.eventHandler(f)});b._canvas.addEventListener("mouseup",function(f){c.eventHandler(f)});b._canvas.addEventListener("mousemove",function(f){c.eventHandler(f)});b._canvas.addEventListener("touchstart",function(f){c.eventHandler(f)});b._canvas.addEventListener("touchend",function(f){c.eventHandler(f)});b._canvas.addEventListener("touchmove",function(f){c.eventHandler(f)});b._canvas.addEventListener("contextmenu",function(f){c.eventHandler(f)})}b._tempDraw=c._currentLevel.draw;b._tempUpdate=c._currentLevel.update;b.initializeProgressResource();var e=function(){c._isRun=true;c.stop();c.draw=c._tempDraw.bind(c._currentLevel);c.update=c._tempUpdate.bind(c._currentLevel);c.run()};var d=function(){c._isInit=true;c.draw=c.loadingProgress;c.update=function(){};c.run();c._isRun=false;c.initialize();if(a.ResourceManager.getRequestCount()===a.ResourceManager.getResponseCount()){e()}};a.ResourceManager.setSubjectFunction(function(){if(!c._isInit){d();return}if(!c._isRun){e()}});d();a.KeyBoardManager.addSubject(c._currentLevel);a.KeyBoardManager.setKeyupEvent(c._currentLevel.keyup);a.KeyBoardManager.setKeydownEvent(c._currentLevel.keydown)};b.run=function(){b._run=(function(e){var d=(new Date()).getTime();var c=1000/e._updateFPS;return function(){while((new Date()).getTime()>d){e._fpsAnalysis.update();if(e.fpsContext){e.fpsContext.innerHTML="update FPS:"+e._fpsAnalysis.getUpdateFPS()+"<br />draw FPS:"+e._drawfpsAnalysis.getUpdateFPS()}e.update();d+=c}e._context.clearRect(0,0,e._canvas.width,e._canvas.height);e.draw(e._context);e._drawfpsAnalysis.update();if(e.fpsContext){e.fpsContext.innerHTML="update FPS:"+e._fpsAnalysis.getUpdateFPS()+"<br />draw FPS:"+e._drawfpsAnalysis.getUpdateFPS()}}})(b);b._runInstance=setInterval(b._run,1000/b._drawFPS);b._isRun=true};b.stop=function(){if(b._isRun){clearInterval(b._runInstance);b._runInstance=null;b._isRun=false}};b.setUpdateFPS=function(c){b._updateFPS=c;b.stop();b.run()};b.getUpdateFPS=function(){return b._updateFPS};b.setDrawFPS=function(c){if(c>60){a.DebugInfo.Log.warring("FPS must be smaller than 60");c=60}b._drawFPS=c;b.stop();b.run()};b.getDrawFPS=function(){return b._drawFPS};b.setCanvas=function(c){if(c){b._canvas=null;b._context=null;b._canvas=c;b._context=b._canvas.getContext("2d")}};b.setContext=function(c){if(c){b.context=null;b._canvas=null;b.context=c}else{a.DebugInfo.Log.error("Game SetContext Error")}};b.getContext=function(){return b.context};return b})();return a})(Framework||{});var Framework=(function(a){a.GameMainMenu=a.Class(a.Level,{__construct:function(){this.autoDelete=false}});return a})(Framework||{});var Framework=(function(a){a.Audio=(function(){var e=a,u={},c={},n={},q=function(){};var A=function(B){n=B};var s=function(B){q=B};var x=function(B){n=e.Util.overrideProperty(B,n)};var r=function(B){n[n]=null;delete n[n]};var z=function(D){var C=0,B=0;if(e.Util.isString(D)){r(D)}else{for(C=0,B=D.length;C<B;C++){r(D[C])}}};var p=function(C){if(!e.Util.isUndefined(c[C])){c[C].currentTime=0;return c[C]}var B=new Audio();B.preload="auto";c[C]=B;return B};var o=function(){this.play();this.removeEventListener("canplaythrough",o,false)};var v=function(J){var C="source",I,G={mp3:"audio/mpeg",ogg:"audio/ogg"},B,H=J.name,D=n[H],F=document.createElement(C),K=document.createElement(C),E={};if(a.Util.isUndefined(D)){throw ("the playlist is not set or do not contain the song: "+H)}E=p(H);E.addEventListener("error",q,false);for(B in J){if(J.hasOwnProperty(B)){E[B]=J[B]}}for(B in D){I=document.createElement(C);I.type=G[B];I.src=D[B];E.appendChild(I)}E.play()};var f=function(C){var B=c[C];B.pause()};var y=function(){for(tempName in c){f(tempName)}};var d=function(C){var B=c[C];if(B.paused){B.play()}};var l=function(){for(tempName in c){d(tempName)}};var b=function(C){var B=c[C];B.pause();B.currentTime=0};var k=function(){for(tempName in c){b(tempName)}};var m=function(B,C){var D=c[B];D.volume=C};var t=function(B,D){var C=c[B];C.muted=D};var h=function(B){t(B,false)};var j=function(){for(tempName in c){h(tempName)}};var g=function(B){t(B,true)};var w=function(){for(tempName in c){g(tempName)}};u=function(B){if(!a.Util.isUndefined(B)){A(B)}};u.prototype={play:v,stop:b,stopAll:k,pause:f,pauseAll:y,resume:d,resumeAll:l,setVolume:m,mute:g,muteAll:w,openVolume:h,openVolumeAll:j,setErrorEvent:s};return u})();return a})(Framework||{});